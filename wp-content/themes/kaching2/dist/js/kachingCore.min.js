(function($){
!function(){"use strict";console.log("kachingCore loaded"),angular.module("kachingCore",["underscore","ngSanitize","ngAnimate","ngCookies","ui.router","mgcrea.ngStrap","oc.lazyLoad","kachingTmpl"]),angular.module("kachingCore").constant("apiUrl",kachingAppConfig.apiUrl).constant("sessionDays",30).controller("kachingCoreCtrl",["$scope","$rootScope","$ocLazyLoad","$urlRouter","$modal","$window","authService",function(e,n,o,t,r,i,a){kachingAppConfig.isHomePage===!0&&a.isLoggedIn()?i.location.href=kachingAppConfig.panelUrl:kachingAppConfig.isPanelPage===!0&&(e.isPanelPage=!0,o.load(kachingAppConfig.wpTemplateUri+"/dist/js/panelApp.min.js").then(function(e){t.sync()})),e.showSignupDialog=function(){r({templateUrl:"kaching-core/components/signupModal/modalTmpl.html",controller:"signupModalCtrl",animation:"am-fade-and-scale",placement:"center"})}}])}(),function(){"use strict";angular.module("kachingCore").factory("utils",[function(){var e=function(e,n,o,t){var r;return e.hasOwnProperty(n)&&"object"==typeof e[n]?r=e[n][o]:e.$parent.hasOwnProperty(n)&&"object"==typeof e.$parent[n]&&(r=e.$parent[n][o]),"undefined"!=typeof r&&("undefined"!=typeof t?!!r.$error[t]:!!r.$invalid)},n=function(e){var n=[],o=[];angular.forEach(e.getNotUploadedItems(),function(e,t){"video"===e.alias?n.push({queueIndex:t}):o.push({queueIndex:t})}),n.length>1&&e.removeFromQueue(n[0].queueIndex),o.length>1&&e.removeFromQueue(o[0].queueIndex)},o=function(e,n,o){var t=Object.keys(o)[0],r=o[t];e.filters.push({name:t,fn:function(e,o){return o.alias!==n||r.indexOf(e.type)!==-1}})},t=function(){var e="\\u00a1-\\uffff",n="(?:25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)){3}",o="([0-9a-f:\\.]+)",t="[a-z"+e+"0-9](?:[a-z"+e+"0-9-]{0,61}[a-z"+e+"0-9])?",r="(?:\\.(?!-)[a-z"+e+"0-9-]{1,63})*",i="";i+="\\.",i+="(?!-)",i+="(?:[a-z"+e+"-]{2,63}",i+="|xn--[a-z0-9]{1,59})",i+="\\.?";var a="("+t+r+i+"|localhost)",s="";return s+="^(?:(?:[a-z0-9\\.\\-\\+]*):\\/\\/)?",s+="(?:\\S+(?::\\S*)?@)?",s+="(?:"+n+"|"+o+"|"+a+")",s+="(?::\\d{2,5})?",s+="(?:[/?#][^\\s]*)?",s+="$",RegExp(s,"i")};return{fieldHasError:e,cleanupUploaderQueue:n,addUploaderTypeFilter:o,urlRegex:t}}])}(),function(){"use strict";angular.module("kachingCore").controller("loginModalCtrl",["$scope","$alert","$modal","$state","$window","authService","utils",function(e,n,o,t,r,i,a){e.view={busy:!1,formError:!1},e.loginFormData={email:"",password:""},e.showSignupDialog=function(){e.$hide(),o({templateUrl:"kaching-core/components/signupModal/modalTmpl.html",controller:"signupModalCtrl",animation:"am-fade-and-scale",placement:"center"})},e.showForgotPasswordDialog=function(){e.$hide(),o({templateUrl:"kaching-core/components/forgotPasswordModal/modalTmpl.html",controller:"forgotPasswordModalCtrl",animation:"am-fade-and-scale",placement:"center"})},e.signinFormSubmit=function(){console.log("in signinFormSubmit()",e.loginFormData.email,e.loginFormData.password),e.view.busy=!0,e.view.formError=!1,i.login(e.loginFormData.email,e.loginFormData.password).then(function(n){e.view.busy=!1,r.location.href=kachingAppConfig.panelUrl},function(){e.view.busy=!1,e.view.formError=!0})}}])}(),function(){"use strict";angular.module("kachingCore").controller("signupModalCtrl",["$scope","errorHandler","$modal","utils","userService",function(e,n,o,t,r){e.fieldHasError=t.fieldHasError,e.view={sending:!1,submitted:!1,success:!1},e.data={firstName:"",lastName:"",email:"",company:"",password:""},e.showErrors=function(){return e.view.submitted},e.clearCustomErrors=function(){e.form1.email.$setValidity("emailRegistered",!0),e.form1.email.$setValidity("emailInvalid",!0)},e.usertypeImgSrc=function(n){var o="";return"advertiser"===n&&(o=1===e.data.usertype?"ic_advertiser_fill.svg":"ic_advertiser.svg"),"publisher"===n&&(o=2===e.data.usertype?"ic_publisher_fill.svg":"ic_publisher.svg"),kachingAppConfig.wpTemplateUri+"/assets/images/"+o};var i=function(e){var n=_.findWhere(e.data.errorDetails.paramsMistake.mistakenParams,{name:"email"});return"undefined"!=typeof n};e.signupFormSubmit=function(){e.view.submitted=!0,e.form1.$valid&&(e.view.sending=!0,r.registerUser(e.data).then(function(n){e.view.success=!0},function(o){e.view.sending=!1,400===o.status&&i(o)?(e.form1.email.$setValidity("emailRegistered",!1),e.view.sending=!1):(n.processApiResponse(o),e.$hide())}))},e.showLoginDialog=function(){e.$hide(),o({templateUrl:"kaching-core/components/loginModal/modalTmpl.html",controller:"loginModalCtrl",animation:"am-fade-and-scale",placement:"center"})}}])}(),function(){"use strict";angular.module("kachingCore").controller("forgotPasswordModalCtrl",["$scope","errorHandler","$modal","utils","userService",function(e,n,o,t,r){e.fieldHasError=t.fieldHasError,e.view={sending:!1,submitted:!1,success:!1},e.data={email:""},e.showErrors=function(){return e.view.submitted},e.formSubmit=function(){e.view.submitted=!0,e.form1.$valid&&(e.view.sending=!0,r.passwordResetRequest(e.data.email).then(function(n){e.view.sending=!1,e.view.success=!0},function(o){n.processApiResponse(o),e.$hide()}))},e.showLoginDialog=function(){e.$hide(),o({templateUrl:"kaching-core/components/loginModal/modalTmpl.html",controller:"loginModalCtrl",animation:"am-fade-and-scale",placement:"center"})}}])}(),function(){"use strict";angular.module("kachingCore").controller("resetPasswordModalCtrl",["$scope","errorHandler","$modal","utils","userService",function(e,n,o,t,r){e.fieldHasError=t.fieldHasError,e.view={sending:!1,submitted:!1,success:!1},e.data={newPassword:"",newPasswordRepeat:"",token:kachingAppConfig.resetPassword.token,uid:kachingAppConfig.resetPassword.uid},e.showErrors=function(){return e.view.submitted},e.formSubmit=function(){e.view.submitted=!0,e.form1.$valid&&(e.view.sending=!0,r.passwordReset(e.data.newPassword,e.data.uid,e.data.token).then(function(){e.view.sending=!1,e.view.success=!0},function(o){n.processApiResponse(o),e.$hide()}))},e.showLoginDialog=function(){e.$hide(),o({templateUrl:"kaching-core/components/loginModal/modalTmpl.html",controller:"loginModalCtrl",animation:"am-fade-and-scale",placement:"center"})}}])}(),function(){"use strict";console.log("apiService loaded"),angular.module("kachingCore").factory("apiService",["$http","$cookies","$q","$window","apiUrl","authToken",function(e,n,o,t,r,i){console.log("in apiService");var a=function(n,a,c,l){console.log("in makeRequest()",n,a,c,l);var u=o.defer(),d={method:n,url:r+a};return c&&("GET"===n?d.params=c:d.data=c),l&&(d.headers={Authorization:"Token "+i.get(!0)}),e(d).then(function(e){console.log("makeRequest() success - response, status",e),u.resolve(e.data)},function(e){console.log("makeRequest() failure - response, status",e),403===e.status&&null===d.url.match(/\/auth\/logout\/$/)&&(s(),t.location.href=kachingAppConfig.panelUrl+"#expired"),u.reject(e)}),u.promise},s=function(){n.remove("usertype",{path:"/"}),i.delete()},c=function(e,n,o){return console.log("in get()"),n="object"==typeof n&&n,o=o===!0,a("GET",e,n,o)},l=function(e,n,o){return console.log("in put()"),n="object"==typeof n&&n,o=o===!0,a("PUT",e,n,o)},u=function(e,n,o){return console.log("in post()"),n="object"==typeof n&&n,o=o===!0,a("POST",e,n,o)},d=function(e,n,o){return console.log("in patch()"),n="object"==typeof n&&n,o=o===!0,a("PATCH",e,n,o)},p=function(e,n,o){return console.log("in delete()"),n="object"==typeof n&&n,o=o===!0,a("DELETE",e,n,o)};return{get:c,put:l,post:u,patch:d,delete:p}}])}(),function(){"use strict";angular.module("kachingCore").factory("authService",["$q","$cookies","utils","apiService","authToken","userService","sessionDays",function(e,n,o,t,r,i,a){var s=function(e){var o=new Date;return o.setDate(o.getDate()+a),"advertiser"===e?!u()&&(n.put("usertype","advertiser",{path:"/",expires:o}),!0):"developer"===e?!d()&&(n.put("usertype","developer",{path:"/",expires:o}),!0):void 0},c=function(){return r.get(!0)!==!1&&"undefined"!=typeof l()},l=function(){return n.get("usertype")},u=function(){return"advertiser"===l()},d=function(){return"developer"===l()},p=function(n,o){var r=e.defer();return t.post("/api-token-auth/",{email:n,password:o}).then(function(e){r.resolve(e.token)},function(e){r.reject(e)}),r.promise},g=function(o,t){var s=e.defer();return n.remove("usertype",{path:"/"}),r.delete(),p(o,t).then(function(e){var o=new Date;o.setDate(o.getDate()+a),r.save(e,o),i.getUser().then(function(e){n.put("usertype","advertiser",{path:"/",expires:o}),s.resolve(e)},function(){s.reject()})},function(){s.reject()}),s.promise},f=function(){var o=e.defer();return t.post("/auth/logout/",!1,!0).finally(function(){n.remove("usertype",{path:"/"}),r.delete(),o.resolve()}),o.promise};return{switchUserType:s,isLoggedIn:c,getUsertype:l,isAdvertiser:u,isDeveloper:d,login:g,logout:f}}])}(),function(){"use strict";console.log("authToken loaded"),angular.module("kachingCore").factory("authToken",["$cookies",function(e){var n,o=function(n,o){e.put("token",n,{path:"/",expires:o})},t=function(){e.remove("token",{path:"/"})},r=function(o){if(n&&!o)return n;var t=e.get("token");return!!t&&(n=t)};return{save:o,delete:t,get:r}}])}(),function(){"use strict";angular.module("kachingCore").factory("userService",["$q","apiService",function(e,n){var o,t=function(){var t=e.defer();return n.get("/auth/me/",!1,!0).then(function(e){console.log("getUser() success",e),o={id:e.id,email:e.email,firstName:e.first_name?e.first_name:"",lastName:e.last_name?e.last_name:"",company:e.company?e.company:"",country:e.country?e.country.toString():void 0,city:e.city?e.city:"",address:e.address?e.address:"",postalCode:e.postal_code?e.postal_code:""},t.resolve(o)},function(e){console.log("getUser() failure",e),t.reject(e)}),t.promise},r=function(){var o=e.defer();return n.get("/auth/me/balance/",!1,!0).then(function(e){console.log("getBalance() success",e),o.resolve(e)},function(e){console.log("getBalance() failure",e),o.reject(e)}),o.promise},i=function(o){var t=e.defer(),r={first_name:o.firstName,last_name:o.lastName,email:o.email,company:o.company,country:o.country,city:o.city,address:o.address,postal_code:o.postalCode};return n.patch("/auth/me/",r,!0).then(function(e){console.log("updateUser() success",e),t.resolve(e)},function(e){console.log("updateUser() failure",e),t.reject(e)}),t.promise},a=function(o,t){var r=e.defer(),i={new_password:t,current_password:o};return n.post("/auth/password/",i,!0).then(function(e){console.log("changePassword() success",e),r.resolve(e)},function(e){console.log("changePassword() failure",e),r.reject(e)}),r.promise},s=function(o){var t=e.defer(),r={email:o};return n.post("/auth/password/reset/",r,!1).then(function(e){console.log("passwordResetRequest() success",e),t.resolve(e)},function(e){console.log("passwordResetRequest() failure",e),t.reject(e)}),t.promise},c=function(o,t,r){var i=e.defer(),a={uid:t,token:r,new_password:o};return n.post("/auth/password/reset/confirm/",a,!1).then(function(e){console.log("passwordReset() success",e),i.resolve(e)},function(e){console.log("passwordReset() failure",e),i.reject(e)}),i.promise},l=function(o){var t=e.defer(),r={first_name:o.firstName,last_name:o.lastName,email:o.email,company:o.company,password:o.password,groups:[1,2]};return n.post("/auth/register/",r,!1).then(function(e){console.log("registerUser() success",e),t.resolve(e)},function(e){console.log("registerUser() failure",e),t.reject(e)}),t.promise},u=function(o,t){var r=e.defer(),i={uid:o,token:t};return n.post("/auth/activate/",i,!1).then(function(e){console.log("activateAccount() success",e),r.resolve(e)},function(e){console.log("activateAccount() failure",e),r.reject(e)}),r.promise},d=function(){var o=e.defer();return n.get("/countries/",null,!0).then(function(e){var n=[];angular.forEach(e,function(e,o){n.push({id:o,name:e})}),o.resolve(n)},function(e){o.reject(e)}),o.promise};return{getUser:t,getBalance:r,updateUser:i,changePassword:a,passwordResetRequest:s,passwordReset:c,registerUser:l,activateAccount:u,getCountries:d}}])}(),function(){"use strict";angular.module("kachingCore").factory("errorHandler",["$alert",function(e){var n=function(n){403!==n.status&&e({title:"ERROR!",content:"An error has occured. Please try again later.",container:"#alerts-container",placement:"top",duration:3,type:"danger",show:!0})};return{processApiResponse:n}}])}(),function(){"use strict";angular.module("kachingCore").directive("loader",function(){return{restrict:"A",templateUrl:"kaching-core/directives/loader/loaderTmpl.html"}})}(),function(){"use strict";angular.module("kachingCore").directive("preventDefault",function(){return{restrict:"A",link:function(e,n,o){(o.ngClick||""===o.href||"#"===o.href)&&n.on("click",function(e){e.preventDefault()})}}})}(),function(){"use strict";angular.module("kachingCore").directive("passwordMatch",[function(){return{require:"ngModel",link:function(e,n,o,t){var r="#"+o.passwordMatch;n.add(r).on("keyup",function(){e.$apply(function(){var e=n.val()===$(r).val();t.$setValidity("pwmatch",e)})})}}}])}(),function(){"use strict";angular.module("kachingCore").directive("panelTitle",["$rootScope","$timeout","$state",function(e,n,o){return{link:function(t,r,i,a){var s=r.text();e.$on("$stateChangeSuccess",function(){var e="";"object"==typeof o.$current.data&&"undefined"!=typeof o.$current.data.title&&(e=o.$current.data.title+" – "),n(function(){r.text(e+s)})})}}}])}(),function(){"use strict";angular.module("kachingCore").directive("kachingHeader",["$window","authService",function(e,n){return{restrict:"A",controller:["$scope",function(o){o.loggedIn=n.isLoggedIn(),o.logoClick=function(){n.isLoggedIn()?e.location.href=kachingAppConfig.homeUrl+"panel/":e.location.href=kachingAppConfig.homeUrl}}]}}])}(),function(){"use strict";angular.module("kachingCore").directive("panelNav",["utils","authService",function(e,n){return{restrict:"A",scope:{loggedIn:"="},templateUrl:"kaching-core/directives/panelNav/panelNavTmpl.html",controller:["$scope",function(e){e.isPanel=kachingAppConfig.isPanelPage,e.urls={campaigns:kachingAppConfig.panelUrl+"#/campaigns",media:kachingAppConfig.panelUrl+"#/media",products:kachingAppConfig.panelUrl+"#/products",billing:kachingAppConfig.panelUrl+"#/billing",apikeys:kachingAppConfig.panelUrl+"#/api-keys"},e.isAdvertiser=function(){return n.isAdvertiser()},e.isDeveloper=function(){return n.isDeveloper()}}]}}])}(),function(){"use strict";angular.module("kachingCore").directive("userNavBar",["$rootScope","userService","authService","$modal","$window","$state",function(e,n,o,t,r,i){return{restrict:"A",scope:{loggedIn:"=",isHomepage:"="},templateUrl:"kaching-core/directives/userNavBar/userNavBarTmpl.html",controller:["$scope",function(a){a.user={},a.username="",a.balance=null,a.isPanel=kachingAppConfig.isPanelPage,a.urls={account:kachingAppConfig.panelUrl+"#/account",funds:kachingAppConfig.panelUrl+"#/add-funds",cards:kachingAppConfig.panelUrl+"#/credit-cards"},a.loggedIn&&(n.getUser().then(function(e){a.user=e,a.username=e.email},function(){}),n.getBalance().then(function(e){a.balance=e.credits_balance})),e.$on("accountBalanceChanged",function(){n.getBalance().then(function(e){a.balance=e.credits_balance})}),a.logout=function(){o.logout().then(function(){r.location.href=kachingAppConfig.homeUrl})},a.isAdvertiser=function(){return o.isAdvertiser()},a.isDeveloper=function(){return o.isDeveloper()},a.switchUserType=function(e){o.switchUserType(e)&&(a.isPanel?"advertiser"===e?i.transitionTo("campaigns"):"developer"===e&&i.transitionTo("apikeys"):r.location.href=kachingAppConfig.panelUrl)},a.showLoginDialog=function(){t({templateUrl:"kaching-core/components/loginModal/modalTmpl.html",controller:"loginModalCtrl",animation:"am-fade-and-scale",placement:"center"})},a.showSignupDialog=function(){t({templateUrl:"kaching-core/components/signupModal/modalTmpl.html",controller:"signupModalCtrl",animation:"am-fade-and-scale",placement:"center"})}}]}}])}(),function(){"use strict";angular.module("kachingCore").directive("resetPassword",["$alert","$modal","utils","userService",function(e,n,o,t){return{restrict:"A",templateUrl:"kaching-core/directives/resetPassword/resetPasswordTmpl.html",controller:["$scope",function(e){e.fieldHasError=o.fieldHasError,e.view={urlError:!1,sending:!1,submitted:!1,success:!1},e.data={newPassword:"",newPasswordRepeat:"",token:kachingQueryParams.token,uid:kachingQueryParams.uid},"undefined"!=typeof kachingQueryParams.uid&&"undefined"!=typeof kachingQueryParams.token||(e.view.urlError=!0),e.showErrors=function(){return e.view.submitted},e.formSubmit=function(){e.view.submitted=!0,e.form1.$valid&&(e.view.sending=!0,t.passwordReset(e.data.newPassword,e.data.uid,e.data.token).then(function(){e.view.sending=!1,e.view.success=!0},function(n){console.log("passwordReset response",n),e.view.urlError=!0}))},e.showLoginDialog=function(){n({templateUrl:"kaching-core/components/loginModal/modalTmpl.html",controller:"loginModalCtrl",animation:"am-fade-and-scale",placement:"center"})},e.showForgotPasswordDialog=function(){n({templateUrl:"kaching-core/components/forgotPasswordModal/modalTmpl.html",controller:"forgotPasswordModalCtrl",animation:"am-fade-and-scale",placement:"center"})}}]}}])}(),function(){"use strict";angular.module("kachingCore").directive("activateAccount",["$alert","$modal","$window","authService","userService","utils",function(e,n,o,t,r,i){return{restrict:"A",templateUrl:"kaching-core/directives/activateAccount/activateAccountTmpl.html",controller:["$scope",function(e){e.view={verificationError:!1,verificationSuccess:!1,verificationProcessing:!1,logginProcessing:!1,formError:!1},e.loginFormData={email:"",password:""},e.view.verificationProcessing=!0,t.logout().then(function(){"string"!=typeof kachingQueryParams.uid||"string"!=typeof kachingQueryParams.token?(e.view.verificationProcessing=!1,e.view.verificationError=!0):r.activateAccount(kachingQueryParams.uid,kachingQueryParams.token).then(function(){e.view.verificationProcessing=!1,e.view.verificationSuccess=!0},function(){e.view.verificationProcessing=!1,e.view.verificationError=!0})}),e.signinFormSubmit=function(){e.view.logginProcessing=!0,e.view.formError=!1,t.login(e.loginFormData.email,e.loginFormData.password).then(function(n){e.view.logginProcessing=!1,o.location.href=kachingAppConfig.panelUrl},function(){e.view.logginProcessing=!1,e.view.formError=!0})}}]}}])}();
})(jQuery);